@page "/audit-log"
@attribute [Authorize]
@inject IAuditLogService _svc
@inject ISweetAlertService swal

@using Syncfusion.Blazor.Grids
@using System.Text.Json

<div id="wrapper" class="app-content-wrapper">
    <div class="app-content-head" style="padding: 0px; height: 0px">

    </div>
    <div id="main-content" class="app-content-body container-fluid">
        @if (_checkActionClientLog)
        {
            <div class="app-content-wrapper">
                <div class="app-content-head" style="height: auto">
                    <disv class="row" style="padding: 0 0 0 5px">
                        <div class="col-12">
                            <ol class="breadcrumb">
                                <li>Quản trị</li>
                                <li style="color: #777">&nbsp; / &nbsp;</li>
                                <li class="active text-primary">Logs hệ thống</li>
                            </ol>
                        </div>
                    </disv>
                </div>
                <div class="app-content-body" style="overflow:auto" id="target">
                    <div class="container-fluid" style="overflow:auto">
                        <SfGrid DataSource="@_dataSource" AllowResizing="true" AllowPaging="true"
                                AllowFiltering="false" EnableVirtualization="true" EnableHover="true"
                                Height="100%" RowHeight="38">
                            <GridPageSettings PageSize="200"></GridPageSettings>
                            <GridColumns>
                                <GridColumn HeaderText="TableName" Field="TableName" Width="200"></GridColumn>
                                <GridColumn HeaderText="ActionType" Field="ActionType" Width="200"></GridColumn>
                                <GridColumn HeaderText="DateCreated" Field="DateCreated" Width="200"></GridColumn>
                                <GridColumn HeaderText="UserName" Field="UserName" Width="200"></GridColumn>
                                <GridColumn HeaderText="IpAddress" Field="IpAddress" Width="200"></GridColumn>
                            </GridColumns>
                            <GridTemplates>
                                <DetailTemplate>
                                    @{
                                        var item = (context as AuditLog);

                                        var tableData = JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(item.ChangeValues)?
                                                    .Select(entry => (
                                                            Field: entry.Key,
                                                            Old: entry.Value.GetProperty("Old").ValueKind == JsonValueKind.Null ? null : entry.Value.GetProperty("Old").ToString(),
                                                            New: entry.Value.GetProperty("New").ValueKind == JsonValueKind.Null ? null : entry.Value.GetProperty("New").ToString()
                                                    )).ToList();

                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th scope="col" width="20%" class="p-2">Field</th>
                                                    <th scope="col" width="40%" class="p-2">Old Value</th>
                                                    <th scope="col" width="40%" class="p-2">New Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var i in tableData)
                                                {
                                                    <tr>
                                                        <td class="p-2">@(i.Field)</td>
                                                        <td class="p-2 text-danger">@i.Old</td>
                                                        <td class="p-2 text-success">@i.New</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    }
                                </DetailTemplate>
                            </GridTemplates>
                        </SfGrid>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="app-content-wrapper wrapper-centered" style="height: calc(100vh - calc(100vh - 100%) - 66px)">
                <div class="app-loading centered text-center">
                    <svg id="Capa_1" enable-background="new 0 0 512 512" height="100" viewBox="0 0 512 512" width="100" xmlns="http://www.w3.org/2000/svg"><g><path d="m507.606 145.568-141.174-141.174c-2.813-2.813-6.628-4.394-10.606-4.394h-199.652c-3.978 0-7.793 1.581-10.606 4.394l-141.174 141.174c-2.813 2.813-4.394 6.628-4.394 10.606v199.651c0 3.978 1.581 7.793 4.394 10.606l141.174 141.174c2.813 2.813 6.628 4.394 10.606 4.394h199.651c3.978 0 7.793-1.581 10.606-4.394l141.174-141.174c2.813-2.813 4.394-6.628 4.394-10.606v-199.651c.001-3.978-1.58-7.793-4.393-10.606z" fill="#f25a3c" /><path d="m512 156.17v199.66c0 3.97-1.58 7.79-4.39 10.6l-141.18 141.18c-2.81 2.81-6.63 4.39-10.6 4.39h-99.83v-512h99.83c3.97 0 7.79 1.58 10.6 4.39l141.18 141.18c2.81 2.81 4.39 6.63 4.39 10.6z" fill="#e43539" /><path d="m237.171 106h37.658c8.728 0 15.613 7.422 14.958 16.126l-12.793 170c-.589 7.826-7.11 13.874-14.958 13.874h-12.073c-7.848 0-14.369-6.049-14.958-13.874l-12.792-170c-.654-8.704 6.23-16.126 14.958-16.126z" fill="#e9f3fb" /><path d="m289.79 122.13-12.8 170c-.58 7.82-7.11 13.87-14.95 13.87h-6.04v-200h18.83c8.73 0 15.61 7.42 14.96 16.13z" fill="#d6e9f8" /><path d="m226.05 375.95v.1c0 16.541 13.409 29.95 29.95 29.95 16.541 0 29.95-13.409 29.95-29.95v-.1c0-16.541-13.409-29.95-29.95-29.95-16.541 0-29.95 13.409-29.95 29.95z" fill="#e9f3fb" /><path d="m285.95 375.95v.1c0 8.27-3.35 15.76-8.77 21.18s-12.91 8.77-21.18 8.77v-60c16.54 0 29.95 13.41 29.95 29.95z" fill="#d6e9f8" /></g></svg>
                    <div class="app-loading-caption mt-2">Lỗi 403!</div>
                    <div class="app-loading-sm-text mt-2">Bạn không có quyền truy cập!</div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private bool _checkActionClientLog;
    private IEnumerable<AuditLog> _dataSource;

    protected override async Task OnInitializedAsync()
    {
        _ = swal.Loading("Nạp thông tin ..");

        _checkActionClientLog = await _svc.CheckAuditLog();

        if (_checkActionClientLog)
        {
            var rsp = await AppStatic.CallApi(() => _svc.GetList());

            if (!rsp.Success)
            {
                _ = swal.Error(rsp.Message);
                return;
            }

            _dataSource = rsp.Items;

            await swal.Close();
        }
        else
        {
            await swal.Close();
        }
    }
}