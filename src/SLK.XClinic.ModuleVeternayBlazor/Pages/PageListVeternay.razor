@page "/customer/list"
@inject Microsoft.JSInterop.IJSRuntime jSRuntime
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Inputs
@using System.Linq
@using Syncfusion.Blazor.SplitButtons
@using Syncfusion.Blazor.DropDowns
@using System.Data
@using Syncfusion.XlsIO
@using System.IO
@using Syncfusion.Blazor.Calendars
@attribute [Authorize]
@inject IVeternayCustomer _svc
@inject ISweetAlertService swal
@inject ITextTranslator Text
@inject FieldExtractor<EntityVeternayCustomer> field


<SfDialog Target="#target" MinHeight ="70%" Width ="800px" Height ="600%" class="dialog-create-employee" IsModal="true" ShowCloseIcon="true" @bind-Visible="_modalVisible">
    <DialogTemplates>
        <Header><span class="title">@_modalTitle</span></Header>
        <Content>
            <EditForm id="editForm" Model="@_model" OnValidSubmit="@OnFormSubmit">
                <DataAnnotationsValidator />
                <div class="form-group row">
                    <div class="col-md-6 mt-3 mt-xl-0 mt-md-0">
                       <div class="row">
                            <div class="col-lg-12">
                                <div class="row">
                                    <label for="name" class="col-md-12 col-form-label">Họ và tên</label>
                                    <div class="col-md-12">
                                        <SfTextBox Placeholder="Họ đệm" @bind-Value="_model.FullName" />
                                        <CustomValidationMessage style="color: red;" For="@(() => _model.FullName)" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="row">
                                    <label for="email" class="col-md-12 col-form-label">Email</label>
                                    <div class="col-md-12">
                                        <SfTextBox Placeholder="Email" @bind-Value="_model.Email" />
                                        <CustomValidationMessage style="color: red;" For="@(() => _model.Email)" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="row">
                                    <label for="phone" class="col-md-12 col-form-label">Phone</label>
                                    <div class="col-md-12">
                                        <SfTextBox Placeholder="Phone" @bind-Value="_model.Phone" />
                                        <CustomValidationMessage style="color: red;" For="@(() => _model.Phone)" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="row">
                                    <label for="address" class="col-md-12 col-form-label">Địa chỉ</label>
                                    <div class="col-md-12">
                                        <SfTextBox Placeholder="Địa chỉ" @bind-Value="_model.Address" />
                                        <CustomValidationMessage style="color: red;" For="@(() => _model.Address)" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="row">
                                    <label for="name" class="col-md-12 col-form-label">Ghi chú</label>
                                    <div class="col-md-12">
                                        <InputTextArea  rows="4" id="note" class="form-control" @bind-Value="_model.Note" />
                                        <CustomValidationMessage For="@(() => _model.Note)" />
                                    </div>
                                </div>
                            </div>
                       </div>
                    </div>
                    <div class="col-lg-6">
                        <h4 class="mb-3">Thú Cưng</h4>
                        <button type="button" class="btn btn-primary mb-3" @onclick="AddPest">Thêm Thú Cưng</button>
                        @if (_formPet != null)
                        {
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5>Nhập Thông Tin Thú Cưng</h5>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="petName" class="col-form-label">Tên Thú Cưng</label>
                                            <SfTextBox Placeholder="Tên thú cưng" @bind-Value="_formPet.Name" />
                                            <CustomValidationMessage style="color: red;" For="@(() => _formPet.Name)" />
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="petType" class="col-form-label">Loại Thú Cưng</label>
                                            <SfComboBox  TItem="OptionDual<string>" TValue="string" PopupHeight="230px"
                                                        @bind-Value="@_formPet.Species" DataSource="@BasicCodes.PetSpeciesOptions">
                                                <ComboBoxFieldSettings Text="@Text["TextEn", "TextVi"]" Value="Value" />
                                                <DropDownListEvents TItem="OptionDual<string>" TValue="string" />
                                            </SfComboBox>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">s
                                            <label for="petBreed" class="col-form-label">Giống Loài</label>
                                            <SfTextBox Placeholder="Giống loài" @bind-Value="_formPet.Breed" />
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="petAge" class="col-form-label">Tuổi</label>
                                            <SfNumericTextBox Placeholder="Tuổi" @bind-Value="_formPet.Age" Min="0" />
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="petGender" class="col-form-label">Giới Tính</label>
                                            <SfComboBox TItem="OptionDual<string>" TValue="string" PopupHeight="230px"
                                                        @bind-Value="@_formPet.Gender" DataSource="@BasicCodes.GenderOptions">
                                                <ComboBoxFieldSettings Text="@Text["TextEn", "TextVi"]" Value="Value" />
                                                <DropDownListEvents TItem="OptionDual<string>" TValue="string" />
                                            </SfComboBox>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="petNotes" class="col-form-label">Ghi Chú</label>
                                            <InputTextArea rows="3" class="form-control" @bind-Value="_formPet.MedicalNotes" />
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <button type="button" class="btn btn-success me-2" @onclick="SavePet">Lưu Thú Cưng</button>
                                            <button type="button" class="btn btn-secondary" @onclick="CancePet">Hủy</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        <!-- Danh sách thú cưng đã thêm -->
                        @if (_model.Pets != null && _model.Pets.Any())
                        {
                            <h5>Danh Sách Thú Cưng</h5>
                            <ul class="list-group mb-3">
                                @foreach (var pet in _model.Pets)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>@pet.Name (@pet.Species, @pet.Breed, @pet.Age tuổi, @pet.Gender)</span>
                                        <a class="btn btn-danger btn-sm" @onclick="() => RemotePet(pet)">Xóa</a>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
                
            </EditForm>
        </Content>
    </DialogTemplates>
    <DialogEvents Closed="@OnModalClosed"></DialogEvents>
    <DialogButtons>
        <DialogButton form=editForm class="btn-submit" Type="Syncfusion.Blazor.Popups.ButtonType.Submit" IsPrimary="false" Content="Xác nhận"></DialogButton>
    </DialogButtons>
</SfDialog>
<div class="app-content-wrapper">
    @if (active)
    {
        <div class="app-content-head" style="height: auto">
            <div class="row" style="padding: 0 0 0 5px">
                <div class="col-12">
                    <ol class="breadcrumb">
                        <li>Nhân sự</li>
                        <li style="color: #777">&nbsp; / &nbsp;</li>
                        <li class="active text-primary"> Danh sách</li>
                    </ol>
                </div>
                <div class="col-md-4 col-lg-3 d-none d-md-block">
                    <div class="input-group">
                        <input type="text" class="form-control" style="height: 31px;" placeholder="@Text["Search...", "Tìm kiếm..."]" @bind="_filterSearch" @bind:event="oninput" @onkeyup="OnChange" />
                        <div class="input-group-append">
                            <span class="input-group-text bg-white" style="height: 31px;" id="basic-addon2"><i class="fas fa-search"></i></span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-8 col-lg-9 text-right">
                    <div class="btn-group pr-0">
                        <button class="btn btn-light float-right newplus mr-2" @onclick="NewEmployee_Click"><span class="fas fa-plus"></span> @Text["Employee", "Nhân sự"]</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="app-content-body" style="overflow:auto" id="target">
            <div class="container-fluid" style="overflow:auto">
                <SfGrid AllowTextWrap="true" ID="Grid" @ref="_grid" EnableHover="true" AllowResizing="true" DataSource="@_displaySource" AllowPaging="true" AllowFiltering="true" AllowSorting="true"
                        EnableAdaptiveUI="false" AllowExcelExport="true" AllowPdfExport="true" ShowColumnChooser="true" EnableVirtualization="false" Height="100%">
                    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Menu"></GridFilterSettings>
                    <GridTextWrapSettings WrapMode="WrapMode.Content"></GridTextWrapSettings>
                    <GridPageSettings PageSize="50"></GridPageSettings>
                    <GridColumns>
                        <GridColumn Field=@nameof(EntityVeternayCustomer.FullName) HeaderText="@Text[field[nameof(EntityVeternayCustomer.FullName)]]" Width="160">
                            <Template>
                                @{
                                    var item = (context as EntityVeternayCustomer);
                                    <a href="/employee/profile/@item.Guid" class="fullname">
                                        @item.FullName
                                    </a>
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field=@nameof(EntityVeternayCustomer.Phone) HeaderText="@Text[field[nameof(EntityVeternayCustomer.Phone)]]" Width="160"></GridColumn>
                        <GridColumn Field=@nameof(EntityVeternayCustomer.Email) HeaderText="@Text[field[nameof(EntityVeternayCustomer.Email)]]" Width="160"></GridColumn>
                          <GridColumn HeaderText="@Text["Functions", "Chức năng"]" Width="110" TextAlign="TextAlign.Right">
                            <Template>
                                @{
                                    var item = (context as EntityVeternayCustomer);
                                    <SfDropDownButton CssClass="e-caret-hide float-right" style="padding-left: 13px;" IconCss="fas fa-ellipsis-v">
                                        <DropDownMenuItems>
                                            <DropDownButtonEvents ItemSelected="SelectedTask"></DropDownButtonEvents>
                                            <DropDownMenuItem Id="@(item.Id.ToString())" Text="Sửa"></DropDownMenuItem>
                                        </DropDownMenuItems>
                                    </SfDropDownButton>
                                }
                            </Template>
                        </GridColumn>
                    </GridColumns>
                </SfGrid>
            </div>
        </div>
    }
</div>

@code {
    #region vavariables
    [Parameter]
    public string str { get; set; }
    private SfGrid<EntityVeternayCustomer> _grid;
    private IEnumerable<EntityVeternayCustomer> _dataSource = new List<EntityVeternayCustomer>();
    private List<EntityVeternayCustomer> _displaySource = new();
    private List<OptionItem<Guid>> _optOffices = new();
    private List<OptionItem<Guid>> _optJob = new();
    private EntityveternayPet _formPet = null;
    private EntityVeternayCustomer _model = new();
    private bool active = false;
    private bool _modalVisible = false;
    private bool _filter = false;
    private string _modalTitle;
    private bool _add_Pets  = false;
    private List<OptionDual<string>> _genderOptionsList => @BasicCodes.GenderOptions.ToList();
    private List<OptionDual<string>> _petSpeciesOptions => @BasicCodes.PetSpeciesOptions.ToList();
    private string _filterSearch;
    #endregion
    #region events
    protected override async Task OnInitializedAsync()
    {
        _ = swal.Loading("Nạp thông tin ..");


        await RereshData();
        StateHasChanged();
    }

    private void NewEmployee_Click()
    {
        _modalTitle = "Thêm Khách hàng";
        _modalVisible = true;
    }

    private void OnModalClosed(Object args)
    {
        _model = new EntityVeternayCustomer();
    }
    #endregion

    #region methods
    private async Task RereshData()
    {

        var rsp = await AppStatic.CallApi(() => _svc.GetList());
        if (!rsp.Success)
        {
            _ = swal.Error(rsp.Message);
            return;
        }

        active = true;
        _dataSource = rsp.Items;

        _displaySource = _dataSource.OrderByDescending(x => x.Id).ToList();

        await swal.Close();
        StateHasChanged();
    }

    private async void OnFormSubmit()
    {
        _modalVisible = false;
        _ = swal.Loading("Lưu thông tin..");


        var rsp = await AppStatic.CallApi(() => _svc.Save(_model));
        if (!rsp.Success)
        {
            _ = swal.Error(rsp.Message);
            return;
        }
        await RereshData();
    }

    private void OnChange()
    {
        var query = _dataSource.AsQueryable();

        if (!string.IsNullOrWhiteSpace(_filterSearch))
            query = query.Where(w => w.FullName.ToLower().Contains(_filterSearch.ToLower()));

        _displaySource = query.OrderByDescending(o => o.Id).ToList();
        StateHasChanged();
    }

    private async void Modify(int id)
    {
        var item = _dataSource.Single(t => t.Id == id);
        _model = item;

        _modalTitle = "Hiệu chỉnh khách hàng";
        _modalVisible = true;

        await Task.CompletedTask;
    }

    private void SelectedTask(MenuEventArgs e)
    {
        string text = e.Item.Text.ToLower();
        int id = Convert.ToInt32(e.Item.Id);
        if (text == "sửa")
            Modify(id);
    }

    private void AddPest()
    {
        _formPet = new();
    }
    private void SavePet()
    {
        if (_formPet != null)
        {
            if (string.IsNullOrWhiteSpace(_formPet.Name) || string.IsNullOrWhiteSpace(_formPet.Species) || string.IsNullOrWhiteSpace(_formPet.Gender))
            {
                _ = swal.Error("Vui lòng điền đầy đủ thông tin bắt buộc (Tên, Loại, Giới tính).");
                return;
            }
            _formPet.Guid = Guid.NewGuid();
            _model.Pets.Add(_formPet);
            _formPet = null;
            StateHasChanged();
        }
    }
    private void CancePet()
    {
        _formPet = null;
        StateHasChanged();
    }
    private void RemotePet(EntityveternayPet pet)
    {
        if (_model.Pets.Contains(pet))
        {
            _model.Pets.Remove(pet);
            StateHasChanged();
        }
    }
    #endregion
}